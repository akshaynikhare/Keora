// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum RelationshipType {
  PARENT
  CHILD
  SPOUSE
  SIBLING
}

enum LinkRequestStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum NotificationType {
  LINK_REQUEST
  LINK_APPROVED
  LINK_REJECTED
  TREE_UPDATE
  SYSTEM
}

enum VisibilityLevel {
  PRIVATE
  FAMILY
  PUBLIC
}

enum AdminRole {
  SUPER_ADMIN
  MODERATOR
  SUPPORT
}

enum FlagReason {
  SPAM
  INAPPROPRIATE
  FAKE_PROFILE
  HARASSMENT
  OTHER
}

enum FlagStatus {
  PENDING
  REVIEWED
  APPROVED
  REMOVED
}

model User {
  id              String    @id @default(cuid())
  mobile          String    @unique
  email           String    @unique
  name            String
  password        String
  photoUrl        String?
  dob             DateTime?
  bio             String?
  location        String?
  verifiedAt      DateTime?
  lastLogin       DateTime?

  // Admin & Security fields
  isAdmin         Boolean   @default(false)
  adminRole       AdminRole?
  isSuspended     Boolean   @default(false)
  suspendedAt     DateTime?
  suspendedReason String?
  loginAttempts   Int       @default(0)
  lockedUntil     DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  familyMembers     FamilyMember[]
  sentRequests      LinkRequest[]     @relation("SentRequests")
  receivedRequests  LinkRequest[]     @relation("ReceivedRequests")
  notifications     Notification[]
  treeSettings      TreeSettings?
  sessions          Session[]
  otpCodes          OTPCode[]
  adminActions      AuditLog[]
  socialAccounts    SocialAccount[]
  flaggedContent    FlaggedContent[]  @relation("FlaggedByUser")
  reviewedFlags     FlaggedContent[]  @relation("ReviewedByAdmin")

  @@index([email])
  @@index([mobile])
  @@index([isAdmin])
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  token      String   @unique
  device     String?
  ipAddress  String?
  userAgent  String?
  expiresAt  DateTime
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model OTPCode {
  id        String   @id @default(cuid())
  userId    String?
  mobile    String?
  email     String?
  code      String
  type      String   // "mobile_verification", "email_verification", "password_reset"
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([mobile])
  @@index([email])
  @@index([code])
}

model FamilyMember {
  id            String          @id @default(cuid())
  userId        String
  name          String
  photoUrl      String?
  dob           DateTime?
  gender        Gender?
  bio           String?
  location      String?
  privacyLevel  VisibilityLevel @default(FAMILY)
  isPrimary     Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relations
  user                User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  relationshipsFrom   Relationship[] @relation("MemberFrom")
  relationshipsTo     Relationship[] @relation("MemberTo")

  @@index([userId])
  @@index([name])
}

model Relationship {
  id               String           @id @default(cuid())
  memberId1        String
  memberId2        String
  relationshipType RelationshipType
  createdAt        DateTime         @default(now())

  // Relations
  member1 FamilyMember @relation("MemberFrom", fields: [memberId1], references: [id], onDelete: Cascade)
  member2 FamilyMember @relation("MemberTo", fields: [memberId2], references: [id], onDelete: Cascade)

  @@unique([memberId1, memberId2])
  @@index([memberId1])
  @@index([memberId2])
}

model LinkRequest {
  id               String            @id @default(cuid())
  senderId         String
  receiverId       String
  relationshipType RelationshipType
  message          String?
  status           LinkRequestStatus @default(PENDING)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  sender   User @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  content   String
  link      String?
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
}

model TreeSettings {
  id           String          @id @default(cuid())
  userId       String          @unique
  visibility   VisibilityLevel @default(PRIVATE)
  allowSearch  Boolean         @default(true)
  showDob      Boolean         @default(true)
  showLocation Boolean         @default(true)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String
  action      String   // "user_suspended", "user_deleted", "content_removed", etc.
  targetType  String?  // "user", "content", "system"
  targetId    String?
  details     String?  // JSON string with additional details
  ipAddress   String?
  createdAt   DateTime @default(now())

  // Relations
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
}

model FlaggedContent {
  id           String     @id @default(cuid())
  reporterId   String
  contentType  String     // "profile", "tree", "post", etc.
  contentId    String
  reason       FlagReason
  description  String?
  status       FlagStatus @default(PENDING)
  reviewedBy   String?
  reviewedAt   DateTime?
  reviewNotes  String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  reporter User  @relation("FlaggedByUser", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewer User? @relation("ReviewedByAdmin", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([status])
  @@index([contentType])
  @@index([createdAt])
}

model SocialAccount {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // "google", "facebook", "apple"
  providerId   String   // ID from the provider
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@index([provider])
}
